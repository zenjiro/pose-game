# MediaPipe Pose × OpenCV 2Dゲーム 実装計画（plan.md）

このドキュメントは、Webカメラ入力をMediaPipe Poseで解析し、落下物（岩）を頭で避け、手や足で対処してスコアやライフを管理するオフライン 2 人対戦ゲームの実装計画です。プロジェクト管理・依存関係管理には uv を使用します。

---

## ゴールとゲーム要件（最終形態）
- カメラ入力: OpenCV でWebカメラからフレーム取得し、リアルタイム処理（最低 30 FPS を目標）
- Pose 検出: MediaPipe Pose（将来的に2人対応。初期は1人で検証→複数人対応へ拡張）
- ゲーム: 上からランダムに岩が落ちてくる
  - 頭に当たる: ライフ -1（初期ライフ 3、0 でゲームオーバー）
  - 手に当たる: 岩は壊れるがスコアは加算されない
  - 足に当たる: 岩が壊れてスコア +1
  - スコアが 10 になるとライフ +1（≒ 足ヒット 10 回で +1 と等価）
- 2人オフライン対戦（同一カメラに2人が映る想定）
- 試合時間: 3 分（180 秒）。時間切れ、あるいは片方がゲームオーバーで終了。スコアが高い方が勝ち
- 画面仕様:
  - 最初の画面: Space/Enter で開始、Esc で終了
  - ゲーム中: フルスクリーン表示、Esc で終了
  - 終了画面: Space/Enter で次のゲーム（リスタート）、Esc で終了

---

## 技術スタック
- 言語: Python 3.10+（uv を用いた依存関係・実行管理）
- 主要ライブラリ:
  - OpenCV (`opencv-python`): カメラ入力、描画、フルスクリーン表示、キーボード入力
  - MediaPipe Pose: 人体ランドマークの検出
    - 初期: `mediapipe.solutions.pose.Pose`（単一人物）
    - 2人対応: `mediapipe.tasks.vision.PoseLandmarker`（複数人物）への移行を検討
  - NumPy: 数値処理・座標演算
  - （必要に応じて）`scipy` や自前フィルタでランドマーク平滑化
- プロジェクト管理: uv（`uv venv`, `uv add`, `uv run` など）

---

## プロジェクト構成案
```
.
├─ plan.md
├─ README.md
├─ LICENSE
├─ pyproject.toml              # uv 管理（後で生成）
├─ src/
│  └─ game/
│     ├─ __init__.py
│     ├─ main.py              # エントリポイント（状態管理、ゲームループ）
│     ├─ camera.py            # カメラ初期化、フレーム取得、フルスクリーンウィンドウ
│     ├─ pose.py              # Pose 推論、ランドマーク正規化→ピクセル座標化、平滑化
│     ├─ entities.py          # 岩・プレイヤー・当たり判定形状の定義
│     ├─ collision.py         # 円-円、AABB などの衝突判定
│     ├─ game_state.py        # タイトル/プレイ/ゲームオーバーの状態
│     ├─ gameplay.py          # スポーン、スコア/ライフ更新、タイマー、難易度調整
│     ├─ render.py            # オーバーレイ描画（ランドマーク、ヒットエフェクト、UI）
│     ├─ config.py            # 定数・チューニングパラメータ
│     └─ utils.py             # 共通ユーティリティ（タイマー、ランダム、補間等）
└─ assets/
   ├─ fonts/                  # テキスト描画用フォント（必要なら）
   └─ images/                 # UI、アイコン等（必要なら）
```

---

## uv セットアップ（開発者向け）
- 前提: uv がインストール済み（未導入なら https://docs.astral.sh/uv/ を参照）

```
# 仮想環境作成
uv venv

# 依存追加
uv add opencv-python mediapipe numpy
# （必要に応じて）
uv add --dev black ruff mypy

# 実行（後日 src/game/main.py ができたら）
uv run python -m game.main
```

- `pyproject.toml` には将来的に以下を定義予定:
  - プロジェクト名、Python バージョン、依存関係
  - `tool.uv.scripts` に `run = "python -m game.main"` など

---

## 座標系とランドマークの取り扱い
- MediaPipe Pose のランドマークは正規化座標（[0,1]×[0,1]）で返るため、`(x * width, y * height)` に変換
- 当たり判定用の代表点:
  - 頭: `nose`, `left_ear`, `right_ear` を参考に「頭中心」を推定。左右耳の中点や鼻位置を組み合わせ、半径は耳間距離や目間距離の係数で決める
  - 手: `left_wrist`, `right_wrist`（半径は前腕長や肩幅からスケーリング）
  - 足: `left_ankle`, `right_ankle` または `left_foot_index`, `right_foot_index` を代表点に（足ヒット判定として適切）
- ランドマーク平滑化:
  - 単純移動平均 or 指数移動平均（EMA）でフリッカを低減
  - フレーム欠損時は直近値保持（一定フレームでタイムアウト）

---

## 当たり判定設計
- 形状はまず「円」で近似（軽量・高速）
  - プレイヤー: 頭・手・足を「円」として定義（中心と半径）
  - 岩: 円（スプライト見た目は後で追加可能）
- 判定: `distance(centerA, centerB) < (radiusA + radiusB)`
- 多人数対応:
  - 各プレイヤーIDに割り当て（MediaPipe Tasks で複数ポーズを取得した場合の tracking_id を利用）
  - 岩ごとに最も近いプレイヤーへの接触判定を優先（同時接触は両方に反映しないor同時ヒットとして両方に反映、仕様で決める）

---

## ゲームループと状態管理
- 状態: `TITLE` → `PLAYING` → `GAME_OVER` → （Space/Enter で）`TITLE` へ
- 入力: キーボード（OpenCV の `waitKey`）
  - `Esc`: いつでも終了
  - `Space/Enter`: タイトル→ゲーム開始、ゲームオーバー→再戦
- 更新: 毎フレーム
  1) カメラからフレーム取得
  2) Pose 推論（非同期化/スロットリング検討）
  3) ランドマーク更新（平滑化）
  4) 岩のスポーンと移動（速度・重力・回転は後で拡張）
  5) 当たり判定（頭→ダメージ、手→破壊のみ、足→破壊+スコア）
  6) ライフ・スコア・タイマー更新
  7) 描画（フルスクリーン、UI、ランドマーク、岩）

---

## スコア・ライフ仕様（詳細）
- 初期ライフ: 3
- 頭ヒット: ライフ -1（無敵時間 0.5〜1.0 秒程度を導入して連続ヒット抑制）
- 手ヒット: 岩破壊、スコア +0
- 足ヒット: 岩破壊、スコア +1
- ライフ増加: スコアが 10, 20, 30, ... に到達時 +1（上限は 5〜9 程度で調整可能）
- 2人対戦: プレイヤーごとに独立スコア・ライフ
- 終了条件:
  - 片方がライフ 0 → そのプレイヤーはゲームオーバー。残り時間はもう一方のスコア稼ぎ可 or 即時終了（ここは実装時に選択）
  - 3分経過 → スコア比較で勝敗

---

## パフォーマンス方針
- Pose 推論は遅延要因 → 可能なら解像度を 1280×720 程度に固定し、必要なら 960×540 へダウンサンプル
- Pose を毎フレームではなく「最新フレーム」で回す（フレームスキップやスロットリングも検討）
- 描画は OpenCV の簡易 API を使用（文字描画負荷が高い場合は簡素化）
- 2人対応時は Tasks API で `num_poses=2` とし、検出/トラッキングを活用

---

## セキュリティ・プライバシー
- カメラ映像はローカル処理のみ。外部送信は行わない
- 起動時にカメラ利用を明示（README に記載）

---

## 段階的実装ステップ（要求に対応）
- [x] 1. カメラの入力をそのまま画面に表示（フルスクリーン、Escで終了）
  - 実装済み: GUIカメラセレクタ（常時フルスクリーン）、ライブプレビュー、矢印キーで選択、Enter/Spaceで決定、Rで再スキャン、Escで終了。OpenCV 導入・uv 環境構築・起動確認済み。
- [ ] 2. MediaPipe Pose を使って検出した頭・手・足を画面に重ねて描画
  - 受け入れ基準: 頭/手/足の円がオーバーレイされる（1人分）
- [ ] 3. 上からランダムに岩が落ちてくる
  - 受け入れ基準: ランダム X、一定速度で落ちる岩がフレーム内に生成・消滅
- [ ] 4. 岩と頭の当たり判定
  - 受け入れ基準: 頭に当たると岩が消える、ヒット状態が分かる（UI表示など）
- [ ] 5. 岩と手の当たり判定
  - 受け入れ基準: 手に当たると岩が壊れるがスコアは変化しない
- [ ] 6. 岩と足の当たり判定
  - 受け入れ基準: 足ヒットで岩破壊、スコア +1（UI表示）
- [ ] 7. ライフの計算（初期3、頭ヒットで -1）
  - 受け入れ基準: ライフ UI が減る。0 でそのプレイヤーはゲームオーバー
- [ ] 8. スコアの処理（足ヒットで加算）
  - 受け入れ基準: スコア UI が加算され保持される
- [ ] 9. スコア 10 到達でライフ +1（閾値型: 10, 20, 30, ...）
  - 受け入れ基準: スコアが閾値に到達した瞬間にライフが 1 増える
- [ ] 10. 終了画面（Space/Enter で次のゲーム、Esc で終了）
  - 受け入れ基準: 試合終了後に終了画面へ遷移し、Space/Enter で再戦できる

---

## マルチプレイヤー（2人）対応の方針
- 段階 2 まで単一人物で実装し、段階 6〜9 あたりで複数人物へ拡張
- MediaPipe Tasks の `PoseLandmarker` に移行し `num_poses=2`、`MinPoseDetectionConfidence` 調整
- 2人の同定:
  - tracking_id が利用可能ならそれでプレイヤーを安定割当
  - tracking_id が無い場合、左右位置や前フレームからの最近傍対応で ID 維持

---

## 難易度・ゲームバランス（後日調整）
- 落下頻度、速度、サイズ、同時数の上限
- ヒット時の無敵時間やエフェクト表示時間
- タイムラインで段階的に難化（例: 1分毎に落下頻度を増加）

---

## 将来の拡張
- Pygame/PyGL への描画バックエンド移行（高品質な描画や音）
- 手の詳細判定（MediaPipe Hands）でパンチ/パーム等を区別
- 足のキック方向検出による加点倍率
- 追加オブジェクト（爆弾、回復アイテム、倍率アイテム）
- 設定画面・キャリブレーション（身長や距離に応じた半径自動調整）

---

## リスクと代替案
- リスク: MediaPipe Pose（solutions版）が単一人物想定
  - 代替案: MediaPipe Tasks 版 PoseLandmarker への移行で `num_poses=2`
- リスク: カメラ環境差による FPS 低下
  - 代替案: 解像度/フレームレートの動的調整、Pose スキップ
- リスク: ランドマークの不安定さ
  - 代替案: 平滑化、信頼度による判定抑制、最後に有効だった座標の再利用

---

## 最初に着手するタスク（Step 1）
- `src/game/camera.py` を実装して、フルスクリーンでカメラ映像を表示
- `src/game/main.py` に最小のループ（フルスクリーンウィンドウ作成、Escで終了）
- `pyproject.toml` を uv で作成し、OpenCV 依存のみ追加
- 動作確認: Esc で直ちに終了できること

以上の計画に沿って段階的に開発を進めます。